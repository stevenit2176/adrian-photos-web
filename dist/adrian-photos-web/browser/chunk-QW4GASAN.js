import{I as i,L as u,O as n,Xb as l,ac as d,i as h,p as o,r,y as s,yb as c}from"./chunk-KPKDHJM6.js";var A=(()=>{class a{http;router;API_URL="/api/auth";ACCESS_TOKEN_KEY="access_token";REFRESH_TOKEN_KEY="refresh_token";currentUserSubject=new h(null);currentUser$=this.currentUserSubject.asObservable();isAuthenticated=c(()=>!!this.currentUserSubject.value);isAdmin=c(()=>this.currentUserSubject.value?.role==="admin");constructor(t,e){this.http=t,this.router=e,this.loadUserFromStorage()}loadUserFromStorage(){this.getAccessToken()&&this.getCurrentUser().subscribe({next:e=>this.currentUserSubject.next(e),error:()=>this.clearTokens()})}register(t){return this.http.post(`${this.API_URL}/register`,t).pipe(i(e=>{e.success&&e.data&&this.handleAuthResponse(e.data)}),r(e=>{if(!e.success||!e.data)throw new Error(e.error?.message||"Registration failed");return e.data.user}),s(e=>this.handleError(e)))}login(t){return this.http.post(`${this.API_URL}/login`,t).pipe(i(e=>{e.success&&e.data&&this.handleAuthResponse(e.data)}),r(e=>{if(!e.success||!e.data)throw new Error(e.error?.message||"Login failed");return e.data.user}),s(e=>this.handleError(e)))}logout(){let t=this.getRefreshToken();return this.http.post(`${this.API_URL}/logout`,{refreshToken:t}).pipe(i(()=>{this.clearTokens(),this.currentUserSubject.next(null),this.router.navigate(["/"])}),r(()=>{}),s(()=>(this.clearTokens(),this.currentUserSubject.next(null),this.router.navigate(["/"]),o(()=>new Error("Logout failed")))))}refreshToken(){let t=this.getRefreshToken();return t?this.http.post(`${this.API_URL}/refresh`,{refreshToken:t}).pipe(i(e=>{e.success&&e.data&&(this.setAccessToken(e.data.accessToken),this.setRefreshToken(e.data.refreshToken))}),r(e=>{if(!e.success||!e.data)throw new Error("Token refresh failed");return e.data.accessToken}),s(e=>(this.clearTokens(),this.currentUserSubject.next(null),this.router.navigate(["/login"]),this.handleError(e)))):o(()=>new Error("No refresh token available"))}getCurrentUser(){return this.http.get(`${this.API_URL}/me`).pipe(r(t=>{if(!t.success||!t.data)throw new Error("Failed to get user");return t.data.user}),i(t=>this.currentUserSubject.next(t)),s(t=>this.handleError(t)))}handleAuthResponse(t){this.setAccessToken(t.accessToken),this.setRefreshToken(t.refreshToken),this.currentUserSubject.next(t.user)}getAccessToken(){return localStorage.getItem(this.ACCESS_TOKEN_KEY)}setAccessToken(t){localStorage.setItem(this.ACCESS_TOKEN_KEY,t)}getRefreshToken(){return localStorage.getItem(this.REFRESH_TOKEN_KEY)}setRefreshToken(t){localStorage.setItem(this.REFRESH_TOKEN_KEY,t)}clearTokens(){localStorage.removeItem(this.ACCESS_TOKEN_KEY),localStorage.removeItem(this.REFRESH_TOKEN_KEY)}isAuthenticatedSync(){return!!this.getAccessToken()}isAdminSync(){return this.currentUserSubject.value?.role==="admin"}getCurrentUserValue(){return this.currentUserSubject.value}handleError(t){let e="An error occurred";return t.error?.error?.message?e=t.error.error.message:t.error?.message?e=t.error.message:t.message&&(e=t.message),o(()=>new Error(e))}static \u0275fac=function(e){return new(e||a)(n(l),n(d))};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})}return a})();export{A as a};
