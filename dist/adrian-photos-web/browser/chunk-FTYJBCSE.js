import{$b as k,Ab as f,K as a,N as g,Q as u,fc as T,i as d,p as l,r as n,z as i}from"./chunk-Z7QZQF3E.js";var U=(()=>{class c{http;router;API_URL="/api/auth";ACCESS_TOKEN_KEY="access_token";REFRESH_TOKEN_KEY="refresh_token";currentUserSubject=new d(null);currentUser$=this.currentUserSubject.asObservable();isAuthenticated=f(()=>!!this.currentUserSubject.value);isAdmin=f(()=>this.currentUserSubject.value?.role==="admin");constructor(r,e){this.http=r,this.router=e,this.loadUserFromStorage()}loadUserFromStorage(){let r=this.getAccessToken();if(console.log("[AuthService] Loading user from storage, token exists:",!!r),r)try{let e=this.decodeToken(r),h=e?.exp&&e.exp<Math.floor(Date.now()/1e3);console.log("[AuthService] Token decoded, expired:",h,"exp:",e?.exp,"now:",Math.floor(Date.now()/1e3)),h?(console.log("[AuthService] Token expired, attempting refresh..."),this.getRefreshToken()?this.refreshToken().subscribe({next:()=>{console.log("[AuthService] Token refreshed successfully, loading user..."),this.getCurrentUser().subscribe({next:s=>{console.log("[AuthService] User loaded:",s.email),this.currentUserSubject.next(s)},error:s=>{console.error("[AuthService] Failed to load user after refresh:",s),this.clearTokens()}})},error:s=>{console.error("[AuthService] Token refresh failed:",s),this.clearTokens()}}):(console.warn("[AuthService] No refresh token available, clearing tokens"),this.clearTokens())):(console.log("[AuthService] Token valid, verifying with server..."),setTimeout(()=>{this.getCurrentUser().subscribe({next:t=>{console.log("[AuthService] User verified:",t.email),this.currentUserSubject.next(t)},error:t=>{if(t.message&&t.message.includes("NG0200")){console.warn("[AuthService] HTTP not ready during init, will verify on first navigation");return}console.error("[AuthService] User verification failed:",t),t.status===401||t.status===403?(console.log("[AuthService] Auth error, attempting token refresh..."),this.getRefreshToken()?this.refreshToken().subscribe({next:()=>{console.log("[AuthService] Token refreshed after 401, retrying user load..."),this.getCurrentUser().subscribe({next:o=>{console.log("[AuthService] User loaded after refresh:",o.email),this.currentUserSubject.next(o)},error:o=>{console.error("[AuthService] Failed to load user after refresh retry:",o),this.clearTokens()}})},error:o=>{console.error("[AuthService] Token refresh failed after 401:",o),this.clearTokens()}}):(console.warn("[AuthService] No refresh token for 401 error, clearing tokens"),this.clearTokens())):console.warn("[AuthService] Non-auth error, keeping tokens.")}})},0))}catch(e){console.error("[AuthService] Invalid token format, clearing:",e),this.clearTokens()}else console.log("[AuthService] No token found in storage")}register(r){return this.http.post(`${this.API_URL}/register`,r).pipe(a(e=>{e.success&&e.data&&this.handleAuthResponse(e.data)}),n(e=>{if(!e.success||!e.data)throw new Error(e.error?.message||"Registration failed");return e.data.user}),i(e=>this.handleError(e)))}login(r){return this.http.post(`${this.API_URL}/login`,r).pipe(a(e=>{e.success&&e.data&&this.handleAuthResponse(e.data)}),n(e=>{if(!e.success||!e.data)throw new Error(e.error?.message||"Login failed");return e.data.user}),i(e=>this.handleError(e)))}logout(){let r=this.getRefreshToken();return this.http.post(`${this.API_URL}/logout`,{refreshToken:r}).pipe(a(()=>{this.clearTokens(),this.currentUserSubject.next(null),this.router.navigate(["/"])}),n(()=>{}),i(()=>(this.clearTokens(),this.currentUserSubject.next(null),this.router.navigate(["/"]),l(()=>new Error("Logout failed")))))}refreshToken(){let r=this.getRefreshToken();return r?this.http.post(`${this.API_URL}/refresh`,{refreshToken:r}).pipe(a(e=>{e.success&&e.data&&(this.setAccessToken(e.data.accessToken),this.setRefreshToken(e.data.refreshToken))}),n(e=>{if(!e.success||!e.data)throw new Error("Token refresh failed");return e.data.accessToken}),i(e=>(this.clearTokens(),this.currentUserSubject.next(null),this.router.navigate(["/login"]),this.handleError(e)))):l(()=>new Error("No refresh token available"))}getCurrentUser(){return this.http.get(`${this.API_URL}/me`).pipe(n(r=>{if(!r.success||!r.data)throw new Error("Failed to get user");return r.data.user}),a(r=>this.currentUserSubject.next(r)),i(r=>this.handleError(r)))}handleAuthResponse(r){this.setAccessToken(r.accessToken),this.setRefreshToken(r.refreshToken),this.currentUserSubject.next(r.user)}getAccessToken(){return localStorage.getItem(this.ACCESS_TOKEN_KEY)}setAccessToken(r){localStorage.setItem(this.ACCESS_TOKEN_KEY,r)}getRefreshToken(){return localStorage.getItem(this.REFRESH_TOKEN_KEY)}setRefreshToken(r){localStorage.setItem(this.REFRESH_TOKEN_KEY,r)}clearTokens(){console.log("[AuthService] Clearing all tokens from storage"),localStorage.removeItem(this.ACCESS_TOKEN_KEY),localStorage.removeItem(this.REFRESH_TOKEN_KEY)}isAuthenticatedSync(){return!!this.getAccessToken()}isAdminSync(){if(this.currentUserSubject.value)return this.currentUserSubject.value.role==="admin";let r=this.getAccessToken();if(r)try{return this.decodeToken(r)?.role==="admin"}catch(e){return!1}return!1}decodeToken(r){try{let e=r.split(".");if(e.length!==3)return null;let h=e[1],t=atob(h.replace(/-/g,"+").replace(/_/g,"/"));return JSON.parse(t)}catch(e){return null}}getCurrentUserValue(){return this.currentUserSubject.value}handleError(r){let e="An error occurred";return r.error?.error?.message?e=r.error.error.message:r.error?.message?e=r.error.message:r.message&&(e=r.message),l(()=>new Error(e))}static \u0275fac=function(e){return new(e||c)(u(k),u(T))};static \u0275prov=g({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})();export{U as a};
